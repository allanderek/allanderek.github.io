<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="My quest to stop writing too much code.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Coding Diet (old posts, page 2) | Coding Diet</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="https://allanderek.github.io/index-2.html">
<link rel="prev" href="." type="text/html">
<link rel="next" href="index-1.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://allanderek.github.io/">

                <span id="blog-title">Coding Diet</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>
                </li>
<li>
<a href="stories/curriculum-vitae/">CV</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    
<div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/lazy-calculation/" class="u-url">Lazy calculation</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Allan Clark
            </span></p>
            <p class="dateline"><a href="posts/lazy-calculation/" rel="bookmark"><time class="published dt-published" datetime="2017-01-11T17:47:02Z" title="2017-01-11 17:47">2017-01-11 17:47</time></a></p>
                <p class="commentline">
        
    <a href="posts/lazy-calculation/#disqus_thread" data-disqus-identifier="cache/posts/lazy-calculation.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>In many cases whilst programming there is a decision to be made as to whether
to <em>store</em> some state, or (re)<em>caluate</em> it as and when needed. Obviously every
situation is different and therefore there is no one answer which fits. In this
post I'm going to attempt to explain the distinction and the benefits/drawbacks
of either approach. I hope that just remembering that this choice exists will
force me to make an explicit choice, such that I may think about it a bit more.</p>
<h2>Distinction</h2>
<p>The distinction is a little akin to that between eager evaluation and lazy
evalution but it is not the same. The distinction here is about code-maintenance.
I'll start with a very simple example, and then move to a more realistic example
which involves access to a database, which makes the decision a bit more interesting.</p>
<p>Suppose you have a very simple <code>class</code> representing a person and the children
that they may have:</p>
<pre class="code literal-block"><span></span><span class="k">class</span> <span class="n">Person</span>(<span class="n">object</span>):
    <span class="n">def</span> <span class="n">__init__</span>(<span class="k">self</span>, <span class="n">gender</span>):
        <span class="k">self</span>.<span class="n">gender</span> = <span class="n">gender</span>
        <span class="k">self</span>.<span class="n">boys</span> = []
        <span class="k">self</span>.<span class="n">girls</span> = []

    <span class="n">def</span> <span class="n">have_baby_girl</span>(<span class="k">self</span>)
        <span class="n">girl</span> = <span class="n">Person</span>(<span class="s">'female'</span>)
        <span class="k">self</span>.<span class="n">girls</span>.<span class="n">append</span>(<span class="n">girl</span>)
        <span class="k">return</span> <span class="n">girl</span>

    <span class="n">def</span> <span class="n">have_baby_boy</span>(<span class="k">self</span>):
        <span class="n">boy</span> = <span class="n">Person</span>(<span class="s">'male'</span>)
        <span class="k">self</span>.<span class="n">boys</span>.<span class="n">append</span>(<span class="n">boy</span>)
        <span class="k">return</span> <span class="n">boy</span>
</pre>


<p>Now, suppose somewhere in your code you wish to return the number of children
that a particular person has. You can either keep track of this, or calculate it
on the fly, here is the keep-track-of-it version:</p>
<pre class="code literal-block"><span></span><span class="k">class</span> <span class="n">Person</span>(<span class="n">object</span>):
    <span class="n">def</span> <span class="n">__init__</span>(<span class="k">self</span>, <span class="n">gender</span>):
        <span class="k">self</span>.<span class="n">gender</span> = <span class="n">gender</span>
        <span class="k">self</span>.<span class="n">boys</span> = []
        <span class="k">self</span>.<span class="n">girls</span> = []
        <span class="k">self</span>.<span class="n">number_of_children</span> = <span class="mi">0</span>

    <span class="n">def</span> <span class="n">have_baby_girl</span>(<span class="k">self</span>)
        <span class="n">girl</span> = <span class="n">Person</span>(<span class="s">'female'</span>)
        <span class="k">self</span>.<span class="n">girls</span>.<span class="n">append</span>(<span class="n">girl</span>)
        <span class="k">self</span>.<span class="n">number_of_children</span> += <span class="mi">1</span>
        <span class="k">return</span> <span class="n">girl</span>

    <span class="n">def</span> <span class="n">have_baby_boy</span>(<span class="k">self</span>):
        <span class="n">boy</span> = <span class="n">Person</span>(<span class="s">'boy'</span>)
        <span class="k">self</span>.<span class="n">boys</span>.<span class="n">append</span>(<span class="n">boy</span>)
        <span class="k">self</span>.<span class="n">number_of_children</span> += <span class="mi">1</span>
        <span class="k">return</span> <span class="n">boy</span>
</pre>


<p>Here is a possible calculate-it-on-the-fly version:</p>
<pre class="code literal-block"><span></span><span class="k">class</span> <span class="n">Person</span>(<span class="n">object</span>):
    <span class="n">def</span> <span class="n">__init__</span>(<span class="k">self</span>, <span class="n">gender</span>):
        <span class="k">self</span>.<span class="n">gender</span> = <span class="n">gender</span>
        <span class="k">self</span>.<span class="n">boys</span> = []
        <span class="k">self</span>.<span class="n">girls</span> = []

    <span class="nv">@property</span>
    <span class="n">def</span> <span class="n">number_of_children</span>(<span class="k">self</span>):
        <span class="k">return</span> <span class="n">len</span>(<span class="k">self</span>.<span class="n">boys</span>) + <span class="n">len</span>(<span class="k">self</span>.<span class="n">girls</span>)

    <span class="n">def</span> <span class="n">have_baby_girl</span>(<span class="k">self</span>)
        <span class="n">girl</span> = <span class="n">Person</span>(<span class="s">'female'</span>)
        <span class="k">self</span>.<span class="n">girls</span>.<span class="n">append</span>(<span class="n">girl</span>)
        <span class="k">return</span> <span class="n">girl</span>

    <span class="n">def</span> <span class="n">have_baby_boy</span>(<span class="k">self</span>):
        <span class="n">boy</span> = <span class="n">Person</span>(<span class="s">'boy'</span>)
        <span class="k">self</span>.<span class="n">boys</span>.<span class="n">append</span>(<span class="n">boy</span>)
        <span class="k">return</span> <span class="n">boy</span>
</pre>


<p>In this particular case I prefer the calculate-it-on-the-fly approach. I like
that I did not have to modify any existing code, I only had to add some. If I
add some other method (suppose an <code>adopt</code> method) then in the keep-track-of-it
version I have to make sure I update our state variable <code>number_of_children</code>
appropriately. Finally, if we change our definition of what a 'child' is,
suppose they have to be under 18 years-of-age, then keeping track-of-it, might
not work at all, or if it does I have to be very careful about updating parents
whenever a child ages.</p>
<p>In terms of performance, this is often trickty to evaluate correctly. Essentially,
you're asking whether the calculation of the state on the fly, is more expensive,
than code to keep track of it. This of course depends hugely on often you inspect
the state. You may do a lot of work to keep-track of a state variable that is
never inspected, or inspected only very rarely. On the other hand, if it is
inspected often, but not updated much, the calculate-it-on-the-fly approach,
may be needlessly re-doing the exact same computation many times.</p>
<p>As a side-note there is a <a href="https://pypi.python.org/pypi/lazy/1.2">lazy</a> package
for Python that lets you calculate attributes once when needed, and then stores
the result for later retrieval. Of course if you update anything the calculation
depends upon you have to make sure an invalidate the stored result. I've found
it is useful in the case that an attribute won't ever need to be re-calculated,
but might never need to be calculated at all (and is expensive to do so).</p>
<h2>More interesting example</h2>
<p>For in-memory occurrences such as the simple example above, often the choice is
pretty clear. Code is often clearer if you calculate-it-on-the-fly, and only
resort to keep-track-of-it whenever the value is somewhat expensive to calculate,
used very often, or particularly simple to keep track of.</p>
<p>However, the choice becomes more interesting when the calculation of the value
involves some external state, even if keeping-track-of-it is done on the
external state. A common case is when the state is kept in a database. In Python,
you may well be using an ORM to access the external state. </p>
<p>Consider an online game website, for some game that has four players. Let's
suppose the game is turn-based and players are not expected to be logged in for
the entire duration, but just take their turn whenever they are online. The game
then can be in multiple states: waiting for players, running, finished. So in
some ORM you might describe a game like:</p>
<pre class="code literal-block"><span></span><span class="k">class</span> <span class="n">Game</span>(<span class="n">database</span>.<span class="n">Model</span>):
    <span class="n">player_one_id</span> = <span class="n">Column</span>(<span class="n">Integer</span>, <span class="n">ForeignKey</span>(<span class="s">'user.id'</span>))
    <span class="n">player_two_id</span> = <span class="n">Column</span>(<span class="n">Integer</span>, <span class="n">ForeignKey</span>(<span class="s">'user.id'</span>))
    <span class="n">player_three_id</span> = <span class="n">Column</span>(<span class="n">Integer</span>, <span class="n">ForeignKey</span>(<span class="s">'user.id'</span>))
    <span class="n">player_four_id</span> = <span class="n">Column</span>(<span class="n">Integer</span>, <span class="n">ForeignKey</span>(<span class="s">'user.id'</span>))

    <span class="n">winner_id</span> = <span class="n">Column</span>(<span class="n">Integer</span>, <span class="n">ForeignKey</span>(<span class="s">'user.id'</span>))

    .... <span class="n">bunch</span> <span class="k">of</span> <span class="n">other</span> <span class="n">columns</span> <span class="n">that</span> <span class="n">actually</span> <span class="n">describe</span> <span class="n">the</span> <span class="n">game</span> <span class="k">state</span> ....
</pre>


<p>Now, suppose you wish to display a list of running games for a user, you could
do it something like this:</p>
<pre class="code literal-block"><span></span><span class="k">class</span> <span class="n">Game</span>(<span class="n">database</span>.<span class="n">Model</span>):
    ... <span class="k">as</span> <span class="o">before</span> ...
    <span class="n">state_names</span> = [<span class="s">'waiting'</span>, <span class="s">'running'</span>, <span class="s">'finished'</span>]
    <span class="k">state</span> = <span class="n">Column</span>(<span class="n">Enum</span>(*<span class="n">state_names</span>), <span class="n">nullable</span>=<span class="nb">False</span>, <span class="k">default</span>=<span class="s">'waiting'</span>)

    <span class="nv">@staticmethod</span>
    <span class="n">def</span> <span class="n">running_games</span>(<span class="n">user</span>):
        <span class="n">games</span> = <span class="n">Game</span>.<span class="n">query</span>.<span class="n">filter</span>(
            <span class="n">Game</span>.<span class="k">state</span> == <span class="s">'running'</span>,
            <span class="n">or_</span>(
                <span class="n">Game</span>.<span class="n">player_one_id</span> == <span class="n">user</span>.<span class="n">id</span>,
                <span class="n">Game</span>.<span class="n">player_two_id</span> == <span class="n">user</span>.<span class="n">id</span>,
                <span class="n">Game</span>.<span class="n">player_three_id</span> == <span class="n">user</span>.<span class="n">id</span>,
                <span class="n">Game</span>.<span class="n">player_four_id</span> == <span class="n">user</span>.<span class="n">id</span>,
            )
        ).<span class="nb">all</span>()
        <span class="k">return</span> <span class="n">games</span>

    <span class="nv">@staticmethod</span>
    <span class="n">def</span> <span class="n">open_games</span>(<span class="n">user</span>):
        <span class="n">games</span> = <span class="n">Game</span>.<span class="n">query</span>.<span class="n">filter</span>(
            <span class="n">Game</span>.<span class="k">state</span> == <span class="s">'waiting'</span>,
            <span class="n">and_</span>(
                <span class="n">Game</span>.<span class="n">player_one_id</span> != <span class="n">user</span>.<span class="n">id</span>,
                <span class="n">Game</span>.<span class="n">player_two_id</span> != <span class="n">user</span>.<span class="n">id</span>,
                <span class="n">Game</span>.<span class="n">player_three_id</span> != <span class="n">user</span>.<span class="n">id</span>,
                <span class="n">Game</span>.<span class="n">player_four_id</span> != <span class="n">user</span>.<span class="n">id</span>,
            )
        ).<span class="nb">all</span>()
        <span class="k">return</span> <span class="n">games</span>
</pre>


<p>Using this way you would have to make sure that when the fourth player joins a
game the state is set to 'running', and when the game finishes the state is set
to 'finished', along with the 'winner' being set.</p>
<p>Instead one could use calculate-it-on-the-fly as in:</p>
<pre class="code literal-block"><span></span><span class="k">class</span> <span class="n">Game</span>(<span class="n">database</span>.<span class="n">Model</span>):
    ... <span class="k">as</span> <span class="o">before</span> ...
    <span class="c c-Singleline"># No state column</span>

    <span class="nv">@staticmethod</span>
    <span class="n">def</span> <span class="n">running_games</span>(<span class="n">user</span>):
        <span class="n">games</span> = <span class="n">Game</span>.<span class="n">query</span>.<span class="n">filter</span>(
            <span class="n">Game</span>.<span class="n">player_one_id</span> != <span class="n">None</span>,
            <span class="n">Game</span>.<span class="n">player_two_id</span> != <span class="n">None</span>,
            <span class="n">Game</span>.<span class="n">player_three_id</span> != <span class="n">None</span>,
            <span class="n">Game</span>.<span class="n">player_four_id</span> != <span class="n">None</span>,
            <span class="n">or_</span>(
                <span class="n">Game</span>.<span class="n">player_one_id</span> == <span class="n">user</span>.<span class="n">id</span>,
                <span class="n">Game</span>.<span class="n">player_two_id</span> == <span class="n">user</span>.<span class="n">id</span>,
                <span class="n">Game</span>.<span class="n">player_three_id</span> == <span class="n">user</span>.<span class="n">id</span>,
                <span class="n">Game</span>.<span class="n">player_four_id</span> == <span class="n">user</span>.<span class="n">id</span>,
            ),
            <span class="n">Game</span>.<span class="n">winner_id</span> == <span class="n">None</span>
        ).<span class="nb">all</span>()
        <span class="k">return</span> <span class="n">games</span>

    <span class="nv">@staticmethod</span>
    <span class="n">def</span> <span class="n">open_games</span>(<span class="n">user</span>):
        <span class="n">games</span> = <span class="n">Game</span>.<span class="n">query</span>.<span class="n">filter</span>(
            <span class="n">or_</span>(
                <span class="n">Game</span>.<span class="n">player_one_id</span> == <span class="n">None</span>,
                <span class="n">Game</span>.<span class="n">player_two_id</span> == <span class="n">None</span>,
                <span class="n">Game</span>.<span class="n">player_three_id</span> == <span class="n">None</span>,
                <span class="n">Game</span>.<span class="n">player_four_id</span> == <span class="n">None</span>,
            )
            <span class="n">and_</span>(
                <span class="n">Game</span>.<span class="n">player_one_id</span> != <span class="n">user</span>.<span class="n">id</span>,
                <span class="n">Game</span>.<span class="n">player_two_id</span> != <span class="n">user</span>.<span class="n">id</span>,
                <span class="n">Game</span>.<span class="n">player_three_id</span> != <span class="n">user</span>.<span class="n">id</span>,
                <span class="n">Game</span>.<span class="n">player_four_id</span> != <span class="n">user</span>.<span class="n">id</span>,
            )
        ).<span class="nb">all</span>()
        <span class="k">return</span> <span class="n">games</span>
</pre>


<p>This could be simplified a bit if we assume that players fill slots in order
such that it is never the case that <code>Game.player_four_id</code> is not <code>None</code> whilst
one of the others is. </p>
<p>In this particular case then I think the keep-track-of-it is a little simpler.
But this hugely depends on the logic for joining a game, taking ones turn, and
finishing the game. In particular when a game is finished you have to set the
<code>winner_id</code> column anyway, so it seems like not too much of a burden to
additionally set the <code>state</code> column.</p>
<p>However, there are many situations in which, calculate-it-on-the-fly is more
appropriate. A common case, occurs when the rules for state changes may change.
For example, in the game case, we may decide that as long as there are two
players, people can play the game, which is therefore <code>running</code>. People may
join a <code>running</code> game, provided it is not full, and may leave a <code>running</code> game.
In this case, calculate-it-on-the-fly simply updates the rules for when a game
is <code>running</code>. However, keep-track-of-it, not only has to update its rules for
when to modify a state (including now reverting a game from <code>running</code> to
<code>waiting</code> when someone leaves a two player game), but must also go through the
database and modify the <code>state</code> column of any existing games. To do this, the
database update code will essentially have to mimic the <code>calculate-it-on-the-fly</code>
code anyway.</p>
<h2>Conclusion</h2>
<p>There is often a choice to be made between maintaining some kind of state up-front,
and calculating it whenever it is required. Both are useful and should be used
depending on the situation. Recalling that there is such a choice may help a
programmer to explicitly make that choice, and perhaps even record the reasons
for it.</p>
</div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="." rel="prev">Newer posts</a>
            </li>
            <li class="next">
                <a href="index-1.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="allanderek";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2017         <a href="mailto:allan.clark@gmail.com">Allan Clark</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
