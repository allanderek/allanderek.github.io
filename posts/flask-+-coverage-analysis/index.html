<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Flask + Coverage Analysis | Coding Diet</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://allanderek.github.io/posts/flask-%2B-coverage-analysis/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Allan Clark">
<link rel="prev" href="../selenium-and-casper/" title="Selenium vs CasperJS" type="text/html">
<link rel="next" href="../update-flask%2Bcoverage/" title="Update: Flask+Coverage" type="text/html">
<meta property="og:site_name" content="Coding Diet">
<meta property="og:title" content="Flask + Coverage Analysis">
<meta property="og:url" content="https://allanderek.github.io/posts/flask-%2B-coverage-analysis/">
<meta property="og:description" content="Flask + Coverage Analysis
This post demonstrates a simple web application written in Flask with coverage
analysis for the tests. The main idea should be pretty translatable into most
Python web applic">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-01-25T15:20:50Z">
<meta property="article:tag" content="coverage">
<meta property="article:tag" content="python">
<meta property="article:tag" content="selenium">
<meta property="article:tag" content="testing">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://allanderek.github.io/">

                <span id="blog-title">Coding Diet</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>
                </li>
<li>
<a href="../../rss.xml">RSS feed</a>
                </li>
<li>
<a href="../../stories/curriculum-vitae/">CV</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="../flask-%2B-coverage-analysis/index.md" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="../flask-%2B-coverage-analysis/" class="u-url">Flask + Coverage Analysis</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                    Allan Clark
            </span></p>
            <p class="dateline"><a href="../flask-%2B-coverage-analysis/" rel="bookmark"><time class="published dt-published" datetime="2016-01-25T15:20:50Z" itemprop="datePublished" title="2016-01-25 15:20">2016-01-25 15:20</time></a></p>
                <p class="commentline">
        
    <a href="../flask-%2B-coverage-analysis/#disqus_thread" data-disqus-identifier="cache/posts/flask-+-coverage-analysis.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="../flask-%2B-coverage-analysis/index.md" id="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<h2>Flask + Coverage Analysis</h2>
<p>This post demonstrates a simple web application written in Flask with coverage
analysis for the tests. The main idea should be pretty translatable into most
Python web application frameworks.</p>
<h4>Update</h4>
<p>I've updated this scheme and described the update <a href="../update-flask%2Bcoverage">here</a>.</p>
<h3>tl;dr</h3>
<p>If you're having difficulty getting coverage analysis to work with Flask then
have a look at my <a href="https://github.com/allanderek/flask-coverage-example">example repository</a>.
The main take away is that you simply start the server in a process of its own
using <code>coverage</code> to start it. However, in order for this to work you have to
make sure you can shut the server process down from the test process. To do this
we simply add a new "shutdown" route which is only available under testing. Your
test code, whether written in Python or, say Javascript, can then make a request
to this "shutdown" route once it completes its tests. This allows the server
process to shutdown naturally and therefore allow 'coverage' to complete.</p>
<h3>Introduction</h3>
<p>It's a good idea to test the web applications you author. Most web application
frameworks provide relatively solid means to do this. However, if you're doing
browser automated functional tests against a live server I've found that getting
<a href="https://pypi.python.org/pypi/coverage">coverage</a> to work to be non-trivial. A quick search will reveal similar
difficulties such as <a href="http://stackoverflow.com/questions/23745370/setting-up-coverage-py-with-flask">this</a>
stack overflow question, which ultimately points to the <a href="http://coverage.readthedocs.org/en/latest/subprocess.html">coverage documentation
on sub-processes</a>.</p>
<p>Part of the reason for this might be that the Flask-Testing extension provides
live server testing class that starts your server in testing mode as part of
the start-up of the test. It then also shuts the server process down, but in
so doing does not allow coverage to complete.</p>
<p>A simpler method is to start the server process yourself under coverage. You
then only need a means to shutdown the server programatically. I do this by
adding a <code>shutdown</code> route.</p>
<!-- TEASER_END -->

<h3>Example repository</h3>
<p>If you just wish to look at the code check out the
<a href="https://github.com/allanderek/flask-coverage-example">example repository</a>.</p>
<p>The README should explain how to work this but roughly:</p>
<pre class="code literal-block"><span></span>    $ git clone https://github.com/allanderek/flask-coverage-example.git
    $ <span class="nb">cd</span> flask-coverage-example
    $ . setup.fish <span class="c1"># or source setup.sh</span>
    $ python manage.py <span class="nb">test</span>
</pre>


<p>You should then be able to look in the <code>htmlcov</code> directory to see the source
marked-up with all the lines ran. Specially open the file
<code>htmlcov/app_main_py.html</code>.</p>
<p>To see an example of a missing line, locate the lines:</p>
<pre class="code literal-block"><span></span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">check_fraction</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s1">'50 of 100 is 50%'</span><span class="p">)</span>
        <span class="n">check_fraction</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">'20 of 30 is 66%'</span><span class="p">)</span>
        <span class="n">check_fraction</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">'Invalid: Fraction greater than Total'</span><span class="p">)</span>
        <span class="n">check_fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'0 of 0 is 0%'</span><span class="p">)</span>
</pre>


<p>Comment out some of them, say the bottom two, re-run <code>python manage.py test</code>
and reload <code>htmlcov/app_main_py.html</code> in your browser.</p>
<h3>Server process</h3>
<p><strong>Update:</strong> The code in this section has been updated in the
<a href="../update-flask%2Bcoverage">update post</a> and in the
<a href="https://github.com/allanderek/flask-coverage-example">example repository</a>.</p>
<p>In the <a href="https://github.com/allanderek/flask-coverage-example">example repository</a>
if you look in the <code>manage.py</code> file you'll see the code to start the server
process. This is in the <code>run_with_test_server</code> function which starts the server
<em>and</em> an additional process, that should be the process that you use to actually
test the server. This process can be anything you like such as, in the example's
case <code>pytest app/main.py</code>, or it could be an external call to casperJS
instance if you want to write your browser tests in Javascript.</p>
<p>However, the main points are:</p>
<ul>
<li>Starting the server process under coverage analysis</li>
<li>Waiting for the server process to indicate that it has started listening</li>
<li>Then starting your test process</li>
<li>Waiting for <strong>both</strong> processes to complete.</li>
<li>Finally running <code>coverage report</code> and <code>coverage html</code>
</li>
</ul>
<p>In a simpler form to that in the example repository this would be:</p>
<pre class="code literal-block"><span></span>    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="n">server_command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'coverage'</span><span class="p">,</span> <span class="s1">'run'</span><span class="p">,</span> <span class="s1">'--source'</span><span class="p">,</span> <span class="s1">'app.main'</span><span class="p">,</span>
                      <span class="s1">'manage.py'</span><span class="p">,</span> <span class="s1">'run_test_server'</span><span class="p">]</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">server_command</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s1">' * Running on'</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="n">test_command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'pytest'</span><span class="p">,</span> <span class="s1">'app/main.py'</span><span class="p">]</span>
    <span class="n">test_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">test_command</span><span class="p">)</span>
    <span class="n">test_process</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">server_return_code</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">"coverage report -m"</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">"coverage html"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">server_return_code</span>
</pre>


<h3>Closing down the server</h3>
<p>Notice that the above <strong>waits</strong> for the server process to end. Ordinarily the
server process has to be killed since it expects to run indefinitely. To solve
that we add a <code>shutdown</code> route. This is done in <code>manage.py</code>:</p>
<pre class="code literal-block"><span></span><span class="k">def</span> <span class="nf">shutdown</span><span class="p">():</span>
    <span class="sd">"""Shutdown the Werkzeug dev server, if we're using it.</span>
<span class="sd">    From http://flask.pocoo.org/snippets/67/"""</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'werkzeug.server.shutdown'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">'Not running with the Werkzeug Server'</span><span class="p">)</span>
    <span class="n">func</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">'Server shutting down...'</span>


<span class="nd">@manager.command</span>
<span class="k">def</span> <span class="nf">run_test_server</span><span class="p">():</span>
    <span class="sd">"""Used by the phantomjs tests to run a live testing server"""</span>
    <span class="c1"># running the server in debug mode during testing fails for some reason</span>
    <span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'DEBUG'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'TESTING'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'TEST_SERVER_PORT'</span><span class="p">]</span>
    <span class="c1"># Don't use the production database but a temporary test database.</span>
    <span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'SQLALCHEMY_DATABASE_URI'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"sqlite:///test.db"</span>
    <span class="n">database</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Add a route that allows the test code to shutdown the server, this allows</span>
    <span class="c1"># us to quit the server without killing the process thus enabling coverage</span>
    <span class="c1"># to work.</span>
    <span class="n">application</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s1">'/shutdown'</span><span class="p">,</span> <span class="s1">'shutdown'</span><span class="p">,</span> <span class="n">shutdown</span><span class="p">,</span>
                             <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'POST'</span><span class="p">,</span> <span class="s1">'GET'</span><span class="p">])</span>

    <span class="n">application</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">use_reloader</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">threaded</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">database</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
</pre>


<p>This code mostly speaks for itself. The <code>shutdown</code> method is obviously the one
we wish to call when the tests are done. We add it to the application route
handler via the call to <code>application.add_url_rule</code>. An alternative is to use a
decorator to mark routes as 'test-only'. I quite like the method used here since
it means the routes are only ever added at all when we start the test server.</p>
<h4>Startup and Shutdown</h4>
<p>For many test strategies you will want to do something before and after the
server runs. In this example we setup the database to use a temporary database,
in which we create all of the tables anew:</p>
<pre class="code literal-block"><span></span>    <span class="c1"># Don't use the production database but a temporary test database.</span>
    <span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">'SQLALCHEMY_DATABASE_URI'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"sqlite:///test.db"</span>
    <span class="n">database</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre>


<p>At the end of the test we remove the database session and drop all of the
contents of the database.</p>
<pre class="code literal-block"><span></span>    <span class="n">database</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="n">database</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
</pre>


<p>In a real test-suite you may well have a way of factoring out this start-up and
tear-down code, but I've left it as simple and test-framework agnostic for this
example as I could.</p>
<h4>At the end of your tests</h4>
<p><strong>Update:</strong> This section is now not required. See the
<a href="../update-flask%2Bcoverage">update post</a>.</p>
<p>Now for this <code>shutdown</code> to actually work, your test suite has to call access
the <code>shutdown</code> route. There are many ways to write this and it will hugely
depend on your test framework. However, in the example repository it is done
via:</p>
<pre class="code literal-block"><span></span><span class="k">finally</span><span class="p">:</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">get_url</span><span class="p">(</span><span class="s1">'shutdown'</span><span class="p">))</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>


<p>In the <code>test_my_server</code> method. <strong>Update:</strong> Not now it isn't as this is not
required at all.</p>
<h3>Conclusion</h3>
<p>Go see the <a href="https://github.com/allanderek/flask-coverage-example">example repository</a>.</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/coverage/" rel="tag">coverage</a></li>
            <li><a class="tag p-category" href="../../categories/python/" rel="tag">python</a></li>
            <li><a class="tag p-category" href="../../categories/selenium/" rel="tag">selenium</a></li>
            <li><a class="tag p-category" href="../../categories/testing/" rel="tag">testing</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../selenium-and-casper/" rel="prev" title="Selenium vs CasperJS">Previous post</a>
            </li>
            <li class="next">
                <a href="../update-flask%2Bcoverage/" rel="next" title="Update: Flask+Coverage">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="allanderek",
            disqus_url="https://allanderek.github.io/posts/flask-%2B-coverage-analysis/",
        disqus_title="Flask + Coverage Analysis",
        disqus_identifier="cache/posts/flask-+-coverage-analysis.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="allanderek";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2017         <a href="mailto:allan.clark@gmail.com">Allan Clark</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
