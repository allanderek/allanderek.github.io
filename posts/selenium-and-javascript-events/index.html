<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<base href="https://allanderek.github.io/posts/selenium-and-javascript-events/">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Selenium and Javascript Events | Coding Diet</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://allanderek.github.io/posts/selenium-and-javascript-events/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Allan Clark">
<link rel="prev" href="../method-cascading/" title="Method Cascading" type="text/html">
<link rel="next" href="../dynamically-typed-languages-why/" title="In what ways are dynamically typed languages more productive?" type="text/html">
<meta property="og:site_name" content="Coding Diet">
<meta property="og:title" content="Selenium and Javascript Events">
<meta property="og:url" content="https://allanderek.github.io/posts/selenium-and-javascript-events/">
<meta property="og:description" content="Selenium is a great way to test web applications and it has Python bindings.
I explained in a previous post how to
set this up with coverage analysis.
However, writing tests is non-trivial, in particu">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-03-16T18:02:32Z">
<meta property="article:tag" content="python">
<meta property="article:tag" content="selenium">
<meta property="article:tag" content="testing">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://allanderek.github.io/">

                <span id="blog-title">Coding Diet</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>
                </li>
<li>
<a href="../../rss.xml">RSS feed</a>
                </li>
<li>
<a href="../../stories/curriculum-vitae/">CV</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="index.md" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Selenium and Javascript Events</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                    Allan Clark
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2016-03-16T18:02:32Z" itemprop="datePublished" title="2016-03-16 18:02">2016-03-16 18:02</time></a></p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/selenium-and-javascript-events.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="index.md" id="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>Selenium is a great way to test web applications and it has Python bindings.
I explained in a <a href="../flask-%2B-coverage-analysis">previous post</a> how to
set this up with coverage analysis.</p>
<p>However, writing tests is non-trivial, in particular it is easy enough to write
tests that suffer from race conditions. Suppose you write a test that includes
a check for the existence of a particular DOM element. Here is a convenient method
to make doing so a one-liner. It assumes that you are within a class that has
the web driver as a member and that you're using 'pytest' but you can easily
adapt this for your own needs.</p>
<pre class="code literal-block"><span></span><span class="k">def</span> <span class="nf">assertCssSelectorExists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">css_selector</span><span class="p">):</span>
    <span class="sd">""" Asserts that there is an element that matches the given</span>
<span class="sd">    css selector."""</span>
    <span class="c1"># We do not actually need to do anything special here, if the</span>
    <span class="c1"># element does not exist we fill fail with a NoSuchElementException</span>
    <span class="c1"># however we wrap this up in a pytest.fail because the error message</span>
    <span class="c1"># is then a bit nicer to read.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span><span class="n">css_selector</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">NoSuchElementException</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s2">"Element {0} not found!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">css_selector</span><span class="p">))</span>
</pre>


<p>The problem is that this test might fail if it is performed too early. If you
are merely testing after loading a page, this should work, however you may be
testing after some click by a user which invokes a Javascript method.</p>
<p>Suppose you have an application which loads a page, and then loads all comments
made on that page (perhaps it is a blog engine). Now suppose you wish to allow
re-loading the list of comments without re-loading the entire page. You might
have an Ajax call.</p>
<p>As before I tend to write my Javascript in Coffeescript, so suppose I have a
Coffeescript function which is called when the user clicks on a
<code>#refresh-comment-feed-button</code> button:</p>
<pre class="code literal-block"><span></span><span class="nv">refresh_comments = </span><span class="nf">(page_id) -&gt;</span>
  <span class="nv">posting = </span><span class="nx">$</span><span class="p">.</span><span class="nx">post</span> <span class="s">'/grabcomments'</span><span class="p">,</span> <span class="nv">page_id: </span><span class="nx">page_id</span>
  <span class="nx">posting</span><span class="p">.</span><span class="nx">done</span> <span class="nx">receive_comments</span>
  <span class="nx">posting</span><span class="p">.</span><span class="nx">fail</span> <span class="nf">(data) -&gt;</span>
    <span class="p">...</span>
</pre>


<p>So this makes an Ajax call which will call the function <code>receive_comments</code>
when the Ajax call returns (successfully). We write the <code>receive_comments</code> as:</p>
<pre class="code literal-block"><span></span><span class="nv">receive_comments = </span><span class="nf">(data) -&gt;</span>
  <span class="p">...</span> <span class="nx">code</span> <span class="nx">to</span> <span class="k">delete</span> <span class="nx">current</span> <span class="nx">comments</span> <span class="o">and</span> <span class="nx">replace</span> <span class="nx">them</span> <span class="nx">with</span> <span class="nx">those</span> <span class="nx">returned</span>
</pre>


<p>Typically <code>data</code> will be some JSON data, perhaps the comments associated with
the <code>page_id</code> we gave as an argument to our Ajax call.</p>
<p>To test this you would navigate to the page in question and check
that there are no comments, then open a new browser window and make two
comments (or alternatively directly adding the comments to the database),
followed by switching back to the first browser window and then
performing the following steps:</p>
<pre class="code literal-block"><span></span>    <span class="n">refresh_comment_feed_css</span> <span class="o">=</span> <span class="s1">'#refresh-comment-feed-button'</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">click_element_with_css</span><span class="p">(</span><span class="n">refresh_comment_feed_css</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_comments</span><span class="p">([</span><span class="n">first_comment</span><span class="p">,</span> <span class="n">second_comment</span><span class="p">])</span>
</pre>


<p>Where <code>self.check_comments</code> is a method that checks the particular comments
exist on the current page. This could be done by using
<code>find_elements_by_css_selector</code> and then looking at the <code>text</code> attributes of
each returned element.</p>
<p>The problem is, that the final line is likely to be run before the results of
the Ajax call invoked from the click on the <code>#refresh-comment-feed-button</code> are
returned to the page.</p>
<p>A quick trick to get around this is to simply change the Javascript to somehow
record when the Ajax results are returned and then use Selenium to wait until
the relevant Javascript evaluates to true.</p>
<p>So we change our <code>receive_comments</code> method to be:</p>
<pre class="code literal-block"><span></span><span class="nv">comments_successfully_updated = </span><span class="mi">0</span>
<span class="nv">receive_comments = </span><span class="nf">(data) -&gt;</span>
  <span class="p">...</span> <span class="nx">code</span> <span class="nx">to</span> <span class="k">delete</span> <span class="nx">current</span> <span class="nx">comments</span> <span class="o">and</span> <span class="nx">replace</span> <span class="nx">them</span> <span class="nx">with</span> <span class="nx">those</span> <span class="nx">returned</span>
  <span class="nx">comments_successfully_updated</span> <span class="o">+=</span> <span class="mi">1</span>
</pre>


<p>Note that we only increment the counter after we have updated the page.</p>
<p>Now, we can update our Selenium test to be:</p>
<pre class="code literal-block"><span></span>    <span class="n">refresh_comment_feed_css</span> <span class="o">=</span> <span class="s1">'#refresh-comment-feed-button'</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">click_element_with_css</span><span class="p">(</span><span class="n">refresh_comment_feed_css</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_comment_refresh_count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_comments</span><span class="p">([</span><span class="n">first_comment</span><span class="p">,</span> <span class="n">second_comment</span><span class="p">])</span>
</pre>


<p>The <code>1</code> argument assumes that this will be the first time the comments are
updated during your test. Of course as you run down your test you can increase
this argument as required. The code for the <code>wait_for_comment_refresh_count</code>
is given by:</p>
<pre class="code literal-block"><span></span><span class="kn">from</span> <span class="nn">selenium.webdriver.support.ui</span> <span class="kn">import</span> <span class="n">WebDriverWait</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.support</span> <span class="kn">import</span> <span class="n">expected_conditions</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.by</span> <span class="kn">import</span> <span class="n">By</span>
<span class="o">...</span>

<span class="k">class</span> <span class="nc">MyTest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="o">...</span> <span class="c1"># assume that 'self.driver' is set appropriately.</span>
    <span class="k">def</span> <span class="nf">wait_for_comment_refresh_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">check_refresh_count</span><span class="p">(</span><span class="n">driver</span><span class="p">):</span>
            <span class="n">script</span> <span class="o">=</span> <span class="s1">'return comments_successfully_updated;'</span>
            <span class="n">feed_count</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">feed_count</span> <span class="o">==</span> <span class="n">count</span>
        <span class="n">WebDriverWait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">until</span><span class="p">(</span><span class="n">check_refresh_count</span><span class="p">)</span>
</pre>


<p>The key point is executing the Javascript to check the
<code>comments_successfully_updated</code> variable with <code>driver.execute_script</code>.
We then use a <code>WebDriverWait</code> to wait for a maximum of 5 seconds until the
our condition is satisfied.</p>
<h3>Conclusion</h3>
<p>Updating a Javascript counter to record when Javascript events have occurred
can allow your Selenium tests to synchronise, that is, wait for the correct time
to check the results of a Javascript event.</p>
<p>This can solve problems of getting a <code>StaleElementReferenceException</code> or a
<code>NoSuchElementException</code> because your Selenium test is running a check on an
element too early before your page has been updated.</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/python/" rel="tag">python</a></li>
            <li><a class="tag p-category" href="../../categories/selenium/" rel="tag">selenium</a></li>
            <li><a class="tag p-category" href="../../categories/testing/" rel="tag">testing</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../method-cascading/" rel="prev" title="Method Cascading">Previous post</a>
            </li>
            <li class="next">
                <a href="../dynamically-typed-languages-why/" rel="next" title="In what ways are dynamically typed languages more productive?">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="allanderek",
            disqus_url="https://allanderek.github.io/posts/selenium-and-javascript-events/",
        disqus_title="Selenium and Javascript Events",
        disqus_identifier="cache/posts/selenium-and-javascript-events.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="allanderek";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2016         <a href="mailto:allan.clark@gmail.com">Allan Clark</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
