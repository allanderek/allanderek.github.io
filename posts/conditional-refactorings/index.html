<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Conditional refactorings | Coding Diet</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://allanderek.github.io/posts/conditional-refactorings/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Allan Clark">
<link rel="prev" href="../scottish-local-election-2017/" title="Scottish Local Elections 2017" type="text/html">
<meta property="og:site_name" content="Coding Diet">
<meta property="og:title" content="Conditional refactorings">
<meta property="og:url" content="https://allanderek.github.io/posts/conditional-refactorings/">
<meta property="og:description" content="I have been reading through some of the source code from the requests library. This is one of the more well-known, well-used, well-loved, and well-praised  Python libraries I know of. I came across so">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-04-21T14:41:48+01:00">
<meta property="article:tag" content="conditionals">
<meta property="article:tag" content="python">
<meta property="article:tag" content="refactoring">
<meta property="article:tag" content="requests">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://allanderek.github.io/">

                <span id="blog-title">Coding Diet</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>
                </li>
<li>
<a href="../../rss.xml">RSS feed</a>
                </li>
<li>
<a href="../../stories/curriculum-vitae/">CV</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="index.md" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Conditional refactorings</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                    Allan Clark
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2017-04-21T14:41:48+01:00" itemprop="datePublished" title="2017-04-21 14:41">2017-04-21 14:41</time></a></p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/conditional-refactorings.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="index.md" id="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>I have been reading through some of the <a href="https://github.com/kennethreitz/requests">source code</a> from the <a href="http://docs.python-requests.org/en/master/">requests</a> library. This is one of the more well-known, well-used, well-loved, and well-praised  Python libraries I know of. I came across some conditional code which I personally would refactor. A first refactor I'm pretty confident about whilst a second I'm less certain is an improvement. I'll detail them both and welcome any comments anyone has.</p>
<p>A specific example of this kind of conditional comes in the <a href="https://github.com/kennethreitz/requests/blob/master/requests/adapters.py">adapters module</a> specifically the <a href="https://github.com/kennethreitz/requests/blob/master/requests/adapters.py#L200">cert_verify method</a>. Here is the code in question, slightly snipped for brevity:</p>
<pre class="code literal-block"><span></span>    <span class="k">def</span> <span class="nf">cert_verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">verify</span><span class="p">,</span> <span class="n">cert</span><span class="p">):</span>
        <span class="sd">"""Verify a SSL certificate. This method should not be called from user</span>
<span class="sd">        ...</span>
<span class="sd">        :param verify: Either a boolean, in which case it controls whether we verify</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'https'</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verify</span><span class="p">:</span>

            <span class="n">cert_loc</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c1"># Allow self-specified cert location.</span>
            <span class="k">if</span> <span class="n">verify</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">cert_loc</span> <span class="o">=</span> <span class="n">verify</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cert_loc</span><span class="p">:</span>
                <span class="n">cert_loc</span> <span class="o">=</span> <span class="n">DEFAULT_CA_BUNDLE_PATH</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cert_loc</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cert_loc</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">"Could not find a suitable TLS CA certificate bundle, "</span>
                              <span class="s2">"invalid path: {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cert_loc</span><span class="p">))</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">cert_reqs</span> <span class="o">=</span> <span class="s1">'CERT_REQUIRED'</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">cert_loc</span><span class="p">):</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">ca_certs</span> <span class="o">=</span> <span class="n">cert_loc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">ca_cert_dir</span> <span class="o">=</span> <span class="n">cert_loc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">cert_reqs</span> <span class="o">=</span> <span class="s1">'CERT_NONE'</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">ca_certs</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">ca_cert_dir</span> <span class="o">=</span> <span class="bp">None</span>
</pre>


<p>The two refactors I would consider is the setting of <code>cert_loc</code> and the order of the two conditional branches, ie. the <code>if</code> and <code>else</code> branches.</p>
<h3>Setting <code>cert_loc</code>
</h3>
<p>This kind of pattern is quite common where a variable is set to a particular value and then a condition is evaluated which may result in the variable being updated. In this particular example we have:</p>
<pre class="code literal-block"><span></span>    <span class="n">cert_loc</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Allow self-specified cert location.</span>
    <span class="k">if</span> <span class="n">verify</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">cert_loc</span> <span class="o">=</span> <span class="n">verify</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cert_loc</span><span class="p">:</span>
        <span class="n">cert_loc</span> <span class="o">=</span> <span class="n">DEFAULT_CA_BUNDLE_PATH</span>
</pre>


<p>First of all note that <code>verify</code> cannot be <code>Falsey</code>. So at the end of these conditionals <code>cert_loc</code> will either be <code>DEFAULT_CA_BUNDLE_PATH</code> if <code>verify</code> is exactly <code>True</code> or it will be set to whatever <code>verify</code> is. So we can write this more succinctly as:</p>
<pre class="code literal-block"><span></span>    <span class="n">cert_loc</span> <span class="o">=</span> <span class="n">DEFAULT_CA_BUNDLE_PATH</span> <span class="k">if</span> <span class="n">verify</span> <span class="ow">is</span> <span class="bp">True</span> <span class="k">else</span> <span class="n">verify</span>
</pre>


<p>If you don't like the conditional <em>expression</em> you can do this as:</p>
<pre class="code literal-block"><span></span>    <span class="k">if</span> <span class="n">verify</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">cert_loc</span> <span class="o">=</span> <span class="n">DEFAULT_CA_BUNDLE_PATH</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cert_loc</span> <span class="o">=</span> <span class="n">verify</span>
</pre>


<p>All this was only really possible because we knew that <code>verify</code> could not be <code>Falsey</code>. Still I consider the setting of a variable to a default before then considering whether or not to update it to be a very minor anti-pattern. So imagine that we could not be sure that <code>verify</code> is not <code>Falsey</code>, we could still re-write our conditional without the default setting as:</p>
<pre class="code literal-block"><span></span>    <span class="k">if</span> <span class="n">verify</span> <span class="ow">is</span> <span class="bp">True</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">verify</span><span class="p">:</span>
        <span class="n">cert_loc</span> <span class="o">=</span> <span class="n">DEFAULT_CA_BUNDLE_PATH</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cert_loc</span> <span class="o">=</span> <span class="n">verify</span>
</pre>


<p>More generally where you see the pattern:</p>
<pre class="code literal-block"><span></span>    <span class="n">x</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">cond1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">val1</span>
    <span class="k">if</span> <span class="n">cond2</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">val2</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">default_x</span>
</pre>


<p>Then you can change this to be:</p>
<pre class="code literal-block"><span></span>    <span class="k">if</span> <span class="n">cond1</span> <span class="ow">and</span> <span class="n">val1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">val1</span>
    <span class="k">elif</span> <span class="n">cond2</span> <span class="ow">and</span> <span class="n">val2</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">val2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">default_x</span>
</pre>


<p>Sometimes this is awkward if one or more of the <code>val_?</code> values are interesting expressions.</p>
<p>One defence of the original style is that you know your variable will be set to <em>something</em> so you will never end up with an undefined variable error. However, if this were ever the case then you have not fully written down your logic, and hence the early error is likely a good thing.</p>
<h3>Switch the <code>if</code> and <code>else</code> branches</h3>
<p>A suggestion I often make when you have two branches, such that one is significantly shorter than the other, is to have the shorter branch first. The reason for this is to give the reader less of a "stack" to recall as they are reading through the code. Often when reading code you get to the end of the long branch, to find a shorter second branch but you've forgotten what the original condition was. So, it's tempting to suggest to modify the original condition as:</p>
<pre class="code literal-block"><span></span>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'https'</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verify</span><span class="p">):</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">cert_reqs</span> <span class="o">=</span> <span class="s1">'CERT_NONE'</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">ca_certs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">ca_cert_dir</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">cert_loc</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Allow self-specified cert location.</span>
        <span class="k">if</span> <span class="n">verify</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">cert_loc</span> <span class="o">=</span> <span class="n">verify</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cert_loc</span><span class="p">:</span>
            <span class="n">cert_loc</span> <span class="o">=</span> <span class="n">DEFAULT_CA_BUNDLE_PATH</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cert_loc</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cert_loc</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">"Could not find a suitable TLS CA certificate bundle, "</span>
                          <span class="s2">"invalid path: {0}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cert_loc</span><span class="p">))</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">cert_reqs</span> <span class="o">=</span> <span class="s1">'CERT_REQUIRED'</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">cert_loc</span><span class="p">):</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">ca_certs</span> <span class="o">=</span> <span class="n">cert_loc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">ca_cert_dir</span> <span class="o">=</span> <span class="n">cert_loc</span>
</pre>


<p>I hesitate to suggest it in this case because the original <code>if</code> branch has code which depends upon the condition, namely that <code>verify</code> is not <code>Falsey</code>. However, more generally this can be something of a win for the person reading the code.</p>
<p>So, two pretty simple refactors, thoughts?</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/conditionals/" rel="tag">conditionals</a></li>
            <li><a class="tag p-category" href="../../categories/python/" rel="tag">python</a></li>
            <li><a class="tag p-category" href="../../categories/refactoring/" rel="tag">refactoring</a></li>
            <li><a class="tag p-category" href="../../categories/requests/" rel="tag">requests</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../scottish-local-election-2017/" rel="prev" title="Scottish Local Elections 2017">Previous post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="allanderek",
            disqus_url="https://allanderek.github.io/posts/conditional-refactorings/",
        disqus_title="Conditional refactorings",
        disqus_identifier="cache/posts/conditional-refactorings.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="allanderek";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents Â© 2017         <a href="mailto:allan.clark@gmail.com">Allan Clark</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
